import{B as k,u as c,m as g,Z as _,_ as C,r as i,o as p,c as m,d as a,h as w,w as u,e as h,t as s,$ as P,s as S,y,a0 as N,a1 as R,b as l}from"../../assets/app-8df99815.js";import{C as V,u as $}from"./CloudFlareTurnstile-dd2b6044.js";import{B as v}from"./BaseInputTel-35ebd3b3.js";const E={components:{BaseButton:k,BaseInputTel:v,CloudFlareTurnstile:V},inject:["dialogRef"],data(){const e=c(),n=$(e.config.sendPhoneEnableRecapcha,this.enableRecapcha,this.enableTurnstile);return{token:null,phoneNumber:null,error:{phone_number:null},loadingChange:!1,...n}},computed:{...g(c,["config"])},mounted(){setTimeout(()=>{this.loadRecaptcha(this.$recaptchaInstance)},2e3)},unmounted(){this.unloadRecaptcha(this.$recaptchaInstance)},methods:{async handleChangePhone(){if(!this.loadingChange){this.loadingChange=!0;try{this.token=await this.getCaptchaToken(this.$recaptcha,this.turnstileToken,"send_phone"),await _({phone_number:this.phoneNumber,token:this.token}),this.dialogRef.close({phone_number:this.phoneNumber}),this.resetErrors(this.error),this.showSuccess(this.$t("Phone number updated. A new code has been sent."))}catch(e){this.handleApiErrors(this.error,e)}finally{this.loadingChange=!1}}}},emits:["confirm"]},I={key:0,class:"text-center"};function A(e,n,T,B,o,r){const f=i("BaseInputTel"),b=i("CloudFlareTurnstile"),d=i("BaseButton");return p(),m("form",{onSubmit:n[2]||(n[2]=P((...t)=>r.handleChangePhone&&r.handleChangePhone(...t),["prevent"])),class:"flex flex-col gap-y-base-2"},[a(f,{modelValue:o.phoneNumber,"onUpdate:modelValue":n[0]||(n[0]=t=>o.phoneNumber=t),placeholder:e.$t("Phone Number"),error:o.error.phone_number,autofocus:!0},null,8,["modelValue","placeholder","error"]),e.enableWidget?(p(),m("div",I,[a(b,{modelValue:e.turnstileToken,"onUpdate:modelValue":n[1]||(n[1]=t=>e.turnstileToken=t)},null,8,["modelValue"])])):w("",!0),a(d,{loading:o.loadingChange,disabled:!e.isVerified()},{default:u(()=>[h(s(e.$t("Save and send code")),1)]),_:1},8,["loading","disabled"])],32)}const U=C(E,[["render",A]]),x={components:{BaseInputText:S,BaseButton:k,CloudFlareTurnstile:V},data(){const e=c();return{token:null,code:null,loadingSend:!1,loadingResend:!1,phoneNumber:null,...$(e.config.sendPhoneEnableRecapcha,this.enableRecapcha,this.enableTurnstile)}},computed:{...g(y,["user"]),...g(c,["config"])},mounted(){this.phoneNumber=this.user.phone_number,this.handleSendPhoneVerify(),setTimeout(()=>{this.loadRecaptcha(this.$recaptchaInstance)},2e3)},unmounted(){this.unloadRecaptcha(this.$recaptchaInstance)},methods:{async handleSendPhoneVerify(e=!0){e||(this.loadingResend=!0);try{this.token=await this.getCaptchaToken(this.$recaptcha,this.turnstileToken,"send_phone"),await N({token:this.token}),e||this.showSuccess(this.$t("A new code has been sent to your phone number."))}catch(n){e||this.showError(n.error)}finally{e||(this.loadingResend=!1)}},reEnterPhoneNumber(){this.$dialog.open(U,{props:{header:this.$t("Enter new phone number"),modal:!0,dismissableMask:!0,draggable:!1,class:"enter-phone-modal"},onClose:e=>{e.data&&(this.phoneNumber=e.data.phone_number)}})},async handleCheckPhoneVerify(){this.loadingSend=!0;try{await R(this.code),this.user.already_setup_login?this.$router.push({name:"home"}):this.$router.push({name:"first_login"})}catch(e){this.showError(e.error)}finally{this.loadingSend=!1}},async logout(){try{await y().logout(),window.location.href=`${window.siteConfig.siteUrl}/login`}catch(e){this.showError(e.error)}}}},j={class:"bg-white rounded-base w-full sm:w-96 p-7 mx-auto mb-base-2 dark:bg-slate-800 dark:text-white"},M={class:"flex items-center justify-between mb-4"},W={class:"text-base-lg font-extrabold"},F={class:"mb-1"},D={key:0,class:"text-center"},L={class:"flex flex-col gap-base-2"},Z={class:"mt-base-2 text-center"};function q(e,n,T,B,o,r){const f=i("BaseInputText"),b=i("CloudFlareTurnstile"),d=i("BaseButton");return p(),m("div",j,[l("div",null,[l("div",M,[l("h3",W,s(e.$t("Enter verification code")),1)]),l("p",F,s(e.$t("We just sent a code to your phone number"))+" "+s(o.phoneNumber)+". "+s(e.$t("Code will expire in 2 minutes.")),1),a(f,{modelValue:o.code,"onUpdate:modelValue":n[0]||(n[0]=t=>o.code=t),class:"w-full mb-base-2",placeholder:e.$t("Code")},null,8,["modelValue","placeholder"]),e.enableWidget?(p(),m("div",D,[a(b,{modelValue:e.turnstileToken,"onUpdate:modelValue":n[1]||(n[1]=t=>e.turnstileToken=t)},null,8,["modelValue"])])):w("",!0),l("div",L,[a(d,{loading:o.loadingSend,disabled:!e.isVerified(),onClick:n[2]||(n[2]=t=>r.handleCheckPhoneVerify())},{default:u(()=>[h(s(e.$t("Continue")),1)]),_:1},8,["loading","disabled"]),a(d,{loading:o.loadingResend,disabled:!e.isVerified(),type:"secondary",onClick:n[3]||(n[3]=t=>r.handleSendPhoneVerify(!1))},{default:u(()=>[h(s(e.$t("Resend code")),1)]),_:1},8,["loading","disabled"]),a(d,{disabled:!e.isVerified(),type:"secondary",onClick:n[4]||(n[4]=t=>r.reEnterPhoneNumber())},{default:u(()=>[h(s(e.$t("Re-enter phone number")),1)]),_:1},8,["disabled"])]),l("div",Z,[h(s(e.$t("Switch account?"))+" ",1),l("button",{class:"text-primary-color dark:text-dark-primary-color",onClick:n[5]||(n[5]=t=>r.logout())},s(e.$t("Logout")),1)])])])}const J=C(x,[["render",q]]);export{J as default};
